import React, { useState, useMemo } from "react";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Shield,
  Package,
  ArrowUpDown,
  ArrowUp,
  ArrowDown,
  ChevronDown,
  ChevronRight,
  Copy,
  Check,
  ExternalLink,
} from "lucide-react";
import type { GrypeReport } from "@/types/jobs";

interface VulnerabilityTabProps {
  grype: GrypeReport;
}

type SortField = "cve" | "severity" | "package" | "installed" | "fixed" | null;
type SortDirection = "asc" | "desc" | null;

const SEVERITY_ORDER: Record<string, number> = {
  Critical: 4,
  High: 3,
  Medium: 2,
  Low: 1,
  Unknown: 0,
  Negligible: 0,
};

const SEVERITY_BADGE: Record<string, string> = {
  Critical: "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",
  High: "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400",
  Medium: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400",
  Low: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400",
  Unknown: "bg-secondary text-muted-foreground",
  Negligible: "bg-secondary text-muted-foreground",
};

const SEVERITY_TEXT: Record<string, string> = {
  Critical: "text-red-600 dark:text-red-400",
  High: "text-orange-500 dark:text-orange-400",
  Medium: "text-yellow-500 dark:text-yellow-400",
  Low: "text-blue-500 dark:text-blue-400",
  Unknown: "text-muted-foreground",
  Negligible: "text-muted-foreground",
};

// rows: [package, installed, fixed, type, CVE, severity]
function parseRows(rows: string[][] | null) {
  return (rows ?? []).map((row) => ({
    packageName: row[0] ?? "",
    installed: row[1] ?? "",
    fixed: row[2] ?? "",
    type: row[3] ?? "",
    cve: row[4] ?? "",
    severity: row[5] ?? "Unknown",
  }));
}

export function VulnerabilityTab({ grype }: VulnerabilityTabProps) {
  const [search, setSearch] = useState("");
  const [debouncedSearch, setDebouncedSearch] = useState("");
  const [sort, setSort] = useState<{ field: SortField; direction: SortDirection }>({
    field: "severity",
    direction: "desc",
  });
  const [expandedRows, setExpandedRows] = useState<Set<string>>(new Set());
  const [copied, setCopied] = useState<Set<string>>(new Set());

  // debounce
  const debounceRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);
  const handleSearch = (val: string) => {
    setSearch(val);
    if (debounceRef.current) clearTimeout(debounceRef.current);
    debounceRef.current = setTimeout(() => setDebouncedSearch(val), 250);
  };

  const allVulns = useMemo(() => parseRows(grype.Table.Rows), [grype]);

  const counts = useMemo(() => {
    const c = { Critical: 0, High: 0, Medium: 0, Low: 0 };
    allVulns.forEach((v) => {
      if (v.severity in c) c[v.severity as keyof typeof c]++;
    });
    return c;
  }, [allVulns]);

  const filtered = useMemo(() => {
    let list = allVulns;
    if (debouncedSearch.trim()) {
      const q = debouncedSearch.toLowerCase();
      list = list.filter(
        (v) =>
          v.cve.toLowerCase().includes(q) ||
          v.packageName.toLowerCase().includes(q) ||
          v.severity.toLowerCase().includes(q) ||
          v.type.toLowerCase().includes(q)
      );
    }
    if (!sort.field || !sort.direction) return list;
    const mult = sort.direction === "asc" ? 1 : -1;
    return [...list].sort((a, b) => {
      switch (sort.field) {
        case "cve":
          return a.cve.localeCompare(b.cve) * mult;
        case "severity":
          return ((SEVERITY_ORDER[a.severity] ?? 0) - (SEVERITY_ORDER[b.severity] ?? 0)) * mult;
        case "package":
          return a.packageName.localeCompare(b.packageName) * mult;
        case "installed":
          return a.installed.localeCompare(b.installed) * mult;
        case "fixed":
          return a.fixed.localeCompare(b.fixed) * mult;
        default:
          return 0;
      }
    });
  }, [allVulns, debouncedSearch, sort]);

  const handleSort = (field: SortField) => {
    setSort((prev) => {
      if (prev.field === field) {
        if (prev.direction === "asc") return { field, direction: "desc" };
        if (prev.direction === "desc") return { field: null, direction: null };
      }
      return { field, direction: "asc" };
    });
  };

  const sortIcon = (field: SortField) => {
    if (sort.field !== field) return <ArrowUpDown className="ml-1 h-3 w-3 inline opacity-30" />;
    if (sort.direction === "asc") return <ArrowUp className="ml-1 h-3 w-3 inline text-blue-500" />;
    if (sort.direction === "desc") return <ArrowDown className="ml-1 h-3 w-3 inline text-blue-500" />;
    return null;
  };

  const toggleRow = (key: string) => {
    setExpandedRows((prev) => {
      const next = new Set(prev);
      next.has(key) ? next.delete(key) : next.add(key);
      return next;
    });
  };

  const handleCopy = async (text: string, key: string) => {
    await navigator.clipboard.writeText(text);
    setCopied((prev) => new Set([...prev, key]));
    setTimeout(() => setCopied((prev) => { const n = new Set(prev); n.delete(key); return n; }), 2000);
  };

  return (
    <div className="p-4 space-y-4">
      {/* Summary cards */}
      <div className="grid grid-cols-4 gap-2">
        {(["Critical", "High", "Medium", "Low"] as const).map((sev) => (
          <Card key={sev} className="shadow-none border border-border">
            <CardContent className="py-0 px-3 flex flex-col h-full min-h-24">
              <span className="text-xs uppercase font-medium text-muted-foreground mb-auto">{sev}</span>
              <div className="mt-auto">
                <p className={`text-4xl font-light mb-1 ${SEVERITY_TEXT[sev]}`}>{counts[sev]}</p>
                <div className="w-full h-1 bg-secondary rounded-full">
                  <div
                    className={`h-1 rounded-full ${sev === "Critical" ? "bg-red-500" :
                        sev === "High" ? "bg-orange-500" :
                          sev === "Medium" ? "bg-yellow-500" : "bg-blue-500"
                      }`}
                    style={{ width: "100%" }}
                  />
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* Search */}
      <Input
        placeholder="Search CVE, package, severity, type..."
        value={search}
        onChange={(e) => handleSearch(e.target.value)}
        className="w-full"
      />

      {/* Table */}
      {filtered.length === 0 ? (
        <div className="text-center py-12">
          <Shield className="h-10 w-10 text-muted-foreground mx-auto mb-3" />
          <p className="text-sm text-muted-foreground">
            {allVulns.length === 0 ? "No vulnerabilities found" : "No results match your search"}
          </p>
        </div>
      ) : (
        <Card className="bg-transparent border border-border">
          <Table>
            <TableHeader>
              <TableRow className="border-b border-border">
                <TableHead className="w-8" />
                <TableHead
                  className="cursor-pointer hover:text-blue-500"
                  onClick={() => handleSort("cve")}
                >
                  CVE {sortIcon("cve")}
                </TableHead>
                <TableHead
                  className="cursor-pointer hover:text-blue-500"
                  onClick={() => handleSort("severity")}
                >
                  Severity {sortIcon("severity")}
                </TableHead>
                <TableHead
                  className="cursor-pointer hover:text-blue-500"
                  onClick={() => handleSort("package")}
                >
                  Package {sortIcon("package")}
                </TableHead>
                <TableHead
                  className="cursor-pointer hover:text-blue-500"
                  onClick={() => handleSort("installed")}
                >
                  Installed {sortIcon("installed")}
                </TableHead>
                <TableHead
                  className="cursor-pointer hover:text-blue-500"
                  onClick={() => handleSort("fixed")}
                >
                  Fixed In {sortIcon("fixed")}
                </TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {filtered.map((vuln, idx) => {
                const rowKey = `${vuln.cve}-${vuln.packageName}-${idx}`;
                const isExpanded = expandedRows.has(rowKey);
                return (
                  <React.Fragment key={rowKey}>
                    <TableRow
                      className="border-b border-border hover:bg-accent/50 cursor-pointer"
                      onClick={() => toggleRow(rowKey)}
                    >
                      <TableCell className="w-8">
                        {isExpanded
                          ? <ChevronDown className="h-4 w-4 text-muted-foreground" />
                          : <ChevronRight className="h-4 w-4 text-muted-foreground" />
                        }
                      </TableCell>
                      <TableCell>
                        <span className="font-mono text-sm text-blue-500">{vuln.cve}</span>
                      </TableCell>
                      <TableCell>
                        <Badge className={SEVERITY_BADGE[vuln.severity] ?? SEVERITY_BADGE.Unknown}>
                          {vuln.severity}
                        </Badge>
                      </TableCell>
                      <TableCell>
                        <div className="flex items-center gap-1">
                          <Package className="h-3 w-3 text-muted-foreground shrink-0" />
                          <span className="font-mono text-xs">{vuln.packageName}</span>
                        </div>
                      </TableCell>
                      <TableCell>
                        <span className="font-mono text-xs text-muted-foreground">{vuln.installed || "â€”"}</span>
                      </TableCell>
                      <TableCell>
                        <span className={`font-mono text-xs ${vuln.fixed ? "text-green-600 dark:text-green-400" : "text-muted-foreground"}`}>
                          {vuln.fixed || "Not available"}
                        </span>
                      </TableCell>
                    </TableRow>

                    {isExpanded && (
                      <TableRow className="bg-muted/30 hover:bg-muted/30">
                        <TableCell colSpan={6} className="p-4">
                          <div className="space-y-3">
                            {/* Score / severity details */}
                            <div className="border rounded-lg overflow-hidden">
                              <div className="bg-muted/50 px-3 py-1.5 flex items-center gap-1.5 text-muted-foreground">
                                <Shield className="h-3.5 w-3.5" />
                                <span className="text-sm font-medium">Details</span>
                              </div>
                              <div className="divide-y divide-border text-sm">
                                {[
                                  { label: "CVE ID", value: vuln.cve },
                                  { label: "Severity", value: vuln.severity },
                                  { label: "Package", value: vuln.packageName },
                                  { label: "Type", value: vuln.type },
                                  { label: "Installed", value: vuln.installed },
                                  { label: "Fixed In", value: vuln.fixed || "Not available" },
                                ].map(({ label, value }) => (
                                  <div key={label} className="flex items-center justify-between px-3 py-2 group">
                                    <span className="text-muted-foreground">{label}</span>
                                    <div className="flex items-center gap-1">
                                      <span className="font-mono text-xs">{value}</span>
                                      <button
                                        onClick={(e) => { e.stopPropagation(); handleCopy(value, `${rowKey}-${label}`); }}
                                        className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-accent rounded"
                                      >
                                        {copied.has(`${rowKey}-${label}`)
                                          ? <Check className="h-3 w-3 text-green-500" />
                                          : <Copy className="h-3 w-3 text-muted-foreground" />
                                        }
                                      </button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>

                            {/* NVD link */}
                            {vuln.cve.startsWith("CVE-") && (
                              <a
                                href={`https://nvd.nist.gov/vuln/detail/${vuln.cve}`}
                                target="_blank"
                                rel="noreferrer"
                                onClick={(e) => e.stopPropagation()}
                                className="inline-flex items-center gap-1 text-xs text-blue-500 hover:underline"
                              >
                                <ExternalLink className="h-3 w-3" />
                                View on NVD
                              </a>
                            )}
                          </div>
                        </TableCell>
                      </TableRow>
                    )}
                  </React.Fragment>
                );
              })}
            </TableBody>
          </Table>
        </Card>
      )}

      <p className="text-xs text-muted-foreground text-right">
        {filtered.length} of {allVulns.length} vulnerabilities
      </p>
    </div>
  );
}
